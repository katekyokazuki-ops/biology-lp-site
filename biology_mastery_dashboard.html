<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è­˜ã®æŠœã‘æ¼ã‚Œã‚¼ãƒ­åŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for visual progress -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 1000px;
        }
        .progress-bar-container {
            height: 12px;
            border-radius: 9999px;
            background-color: #e5e7eb;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
            background-color: #10b981; /* Emerald */
            border-radius: 9999px;
        }
        .checklist-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="container mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ§¬ çŸ¥è­˜ã®æŠœã‘æ¼ã‚Œã‚¼ãƒ­åŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p class="text-gray-500 mb-8">ã€Œæœ€å°æš—è¨˜æˆ¦ç•¥ã€å®Ÿè·µç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‚èª¬æ˜ã§ãã‚‹é …ç›®ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€å¼±ç‚¹ã‚’å¯è¦–åŒ–ã—ã¾ã—ã‚‡ã†ã€‚</p>

        <!-- Firestore/Auth Status -->
        <div id="status-message" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-lg" role="alert">
            <p class="font-bold">åˆæœŸåŒ–ä¸­...</p>
            <p>ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
        </div>

        <!-- ç·åˆé€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <div class="bg-gray-50 p-6 rounded-lg mb-8 shadow-inner">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">âœ… ç·åˆé€²æ—</h2>
            <div id="overall-progress">
                <!-- é€²æ—ç‡ã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¯JSã§æ›´æ–° -->
            </div>
            <div class="flex flex-col sm:flex-row justify-between mt-6 space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/3 p-2">
                    <canvas id="levelChart"></canvas>
                    <p class="text-center text-sm mt-2 text-gray-600">L1/L2ç¿’å¾—ãƒãƒ©ãƒ³ã‚¹</p>
                </div>
                <div class="w-full sm:w-2/3 p-2">
                    <canvas id="themeChart"></canvas>
                    <p class="text-center text-sm mt-2 text-gray-600">ãƒ†ãƒ¼ãƒåˆ¥ç¿’å¾—ç‡</p>
                </div>
            </div>
        </div>

        <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- ãƒ†ãƒ¼ãƒé¸æŠ -->
            <div class="md:col-span-1">
                <label for="theme-select" class="block text-sm font-medium text-gray-700 mb-2">å­¦ç¿’ãƒ†ãƒ¼ãƒã‚’é¸æŠ</label>
                <select id="theme-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    <!-- Options populated by JS -->
                </select>
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                    <p class="font-semibold">ğŸ’¡ ä½¿ã„æ–¹ï¼š</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li>ã€Œäººã«èª¬æ˜ã§ãã‚‹ã€é …ç›®ã ã‘ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ã€‚</li>
                        <li>ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ã€ã‚°ãƒ©ãƒ•ãŒè‡ªå‹•ã§å¼±ç‚¹ã‚’æ•™ãˆã¦ãã‚Œã¾ã™ã€‚</li>
                    </ul>
                </div>
            </div>

            <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º -->
            <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="current-theme-title" class="text-2xl font-semibold text-gray-800">ãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                    <span id="theme-progress-text" class="text-xl font-bold text-emerald-600">0%</span>
                </div>
                <div id="checklist" class="space-y-3">
                    <!-- Checklist items populated by JS -->
                    <p class="text-gray-500 text-center">å·¦å´ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
                </div>
            </div>
        </div>
        
        <!-- User ID for reference -->
        <div id="user-id-display" class="mt-8 p-3 bg-gray-100 rounded-lg text-sm text-gray-600 hidden">
             <!-- User ID will be shown here for support -->
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // setLogLevelã¯firebase-auth.jsã§ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚å‰Šé™¤
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebaseã®è¨­å®šã¨åˆæœŸåŒ– (__firebase_config, __app_id, __initial_auth_token ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§æä¾›ã•ã‚Œã¾ã™)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        // ä¿®æ­£: __initialAuthToken ã§ã¯ãªã __initial_auth_token ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (!firebaseConfig) {
            document.getElementById('status-message').innerHTML = '<p class="font-bold">ã‚¨ãƒ©ãƒ¼:</p><p>Firebaseè¨­å®šãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</p>';
            console.error("Firebase config is missing. Cannot initialize Firebase.");
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆsetLogLevelã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        // setLogLevel('Debug');

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let isAuthReady = false;
        let checklistData = {}; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let currentThemeId = 'T1'; // åˆæœŸè¡¨ç¤ºãƒ†ãƒ¼ãƒ

        // å­¦ç¿’ãƒ†ãƒ¼ãƒã¨ãƒã‚§ãƒƒã‚¯é …ç›®ï¼ˆã‚³ã‚¢çŸ¥è­˜ã¨æµã‚Œ/ãƒ—ãƒ­ã‚»ã‚¹ï¼‰ã®å®šç¾©
        const BIOLOGY_TOPICS = {
            'T1': {
                name: '1. ç´°èƒã¨åˆ†å­',
                items: {
                    L1_A: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: ç´°èƒè†œã®æµå‹•ãƒ¢ã‚¶ã‚¤ã‚¯ãƒ¢ãƒ‡ãƒ«", level: 1 },
                    L1_B: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: é…µç´ ã®åŸºè³ªç‰¹ç•°æ€§ã¨æœ€é©æ¸©åº¦/pH", level: 1 },
                    L1_C: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: ATPã®æ§‹é€ ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼é€šè²¨ã¨ã—ã¦ã®å½¹å‰²", level: 1 },
                    L2_A: { text: "L2 æµã‚Œ: ç‰©è³ªã®èƒ½å‹•è¼¸é€ã¨å—å‹•è¼¸é€ã®ä»•çµ„ã¿", level: 2 },
                    L2_B: { text: "L2 æµã‚Œ: é…µç´ åå¿œé€Ÿåº¦ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å› å­ã®ã‚°ãƒ©ãƒ•è§£é‡ˆ", level: 2 },
                }
            },
            'T2': {
                name: '2. ä»£è¬ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼',
                items: {
                    L1_A: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: å‘¼å¸ã¨å…‰åˆæˆã®å…¨ä½“åå¿œå¼ã¨å ´æ‰€", level: 1 },
                    L1_B: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: è§£ç³–ç³»ã€ã‚¯ã‚¨ãƒ³é…¸å›è·¯ã€é›»å­ä¼é”ç³»ã®åç§°ã¨å½¹å‰²", level: 1 },
                    L2_A: { text: "L2 æµã‚Œ: å‘¼å¸ã«ãŠã‘ã‚‹ATPç”Ÿæˆé‡ã®ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®ATPæ•°ï¼‰", level: 2 },
                    L2_B: { text: "L2 æµã‚Œ: å…‰åˆæˆã®å…‰åŒ–å­¦ç³»Iãƒ»IIã®æ°´ã®åˆ†è§£ã‹ã‚‰NADPHç”Ÿæˆã¾ã§ã®æµã‚Œ", level: 2 },
                }
            },
            'T3': {
                name: '3. éºä¼æƒ…å ±',
                items: {
                    L1_A: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: ã‚»ãƒ³ãƒˆãƒ©ãƒ«ãƒ‰ã‚°ãƒï¼ˆè¤‡è£½ã€è»¢å†™ã€ç¿»è¨³ï¼‰ã®å®šç¾©", level: 1 },
                    L1_B: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: ã‚³ãƒ‰ãƒ³ã¨ã‚¢ãƒŸãƒé…¸ã®é–¢ä¿‚ï¼ˆéºä¼æš—å·è¡¨ã®ä»•çµ„ã¿ï¼‰", level: 1 },
                    L2_A: { text: "L2 æµã‚Œ: DNAè¤‡è£½æ™‚ã®åŠä¿å­˜çš„è¤‡è£½ã¨é–¢ã‚ã‚‹é…µç´ ç¾¤ã®åƒã", level: 2 },
                    L2_B: { text: "L2 æµã‚Œ: ç¿»è¨³ã«ãŠã‘ã‚‹tRNAã¨ãƒªãƒœã‚½ãƒ¼ãƒ ã®å…·ä½“çš„ãªå‹•ã", level: 2 },
                }
            },
            'T4': {
                name: '4. æ’å¸¸æ€§',
                items: {
                    L1_A: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: ãƒ›ãƒ«ãƒ¢ãƒ³ã¨è‡ªå¾‹ç¥çµŒã®å½¹å‰²åˆ†æ‹…", level: 1 },
                    L1_B: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: å…ç–«ã®è‡ªç„¶å…ç–«ã¨ç²å¾—å…ç–«ã®é•ã„", level: 1 },
                    L2_A: { text: "L2 æµã‚Œ: è¡€ç³–å€¤ã®èª¿ç¯€æ©Ÿæ§‹ï¼ˆã‚¤ãƒ³ã‚¹ãƒªãƒ³ã¨ã‚°ãƒ«ã‚«ã‚´ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰", level: 2 },
                    L2_B: { text: "L2 æµã‚Œ: ç²å¾—å…ç–«ã«ãŠã‘ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼Tç´°èƒã®æ´»æ€§åŒ–ã¨æŠ—ä½“ç”£ç”Ÿã¾ã§ã®ãƒ—ãƒ­ã‚»ã‚¹", level: 2 },
                }
            },
            'T5': {
                name: '5. ç”Ÿæ…‹ç³»',
                items: {
                    L1_A: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: ç‹¬ç«‹æ „é¤Šç”Ÿç‰©ã¨å¾“å±æ „é¤Šç”Ÿç‰©ã®å®šç¾©", level: 1 },
                    L1_B: { text: "L1 ã‚³ã‚¢çŸ¥è­˜: çª’ç´ åŒåŒ–ã¨çª’ç´ å›ºå®šã®é•ã„", level: 1 },
                    L2_A: { text: "L2 æµã‚Œ: é·ç§»ã®åˆæœŸæ®µéšã‹ã‚‰æ¥µç›¸ã¾ã§ã®å¤‰é·ã¨æ§‹æˆç¨®ã®ä¾‹", level: 2 },
                    L2_B: { text: "L2 æµã‚Œ: ç”Ÿæ…‹ç³»ã«ãŠã‘ã‚‹ç‚­ç´ ãƒ»çª’ç´ ãƒ»æ°´ã®ç‰©è³ªå¾ªç’°", level: 2 },
                }
            },
        };
        const ALL_ITEMS = Object.values(BIOLOGY_TOPICS).flatMap(t => Object.keys(t.items)).length;

        // --- Chart.js åˆæœŸåŒ– ---
        const levelChartCtx = document.getElementById('levelChart').getContext('2d');
        const themeChartCtx = document.getElementById('themeChart').getContext('2d');
        let levelChart = null;
        let themeChart = null;

        // --- Firebase èªè¨¼ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                
                document.getElementById('status-message').innerHTML = `<p class="font-bold">èªè¨¼å®Œäº†!</p><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId.substring(0, 8)}...</p>`;
                document.getElementById('user-id-display').classList.remove('hidden');
                document.getElementById('user-id-display').textContent = `Full User ID (Support): ${userId}`;

                // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è³¼èª­
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'biology_checklist', 'checklist_data');
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        checklistData = docSnap.data();
                        console.log("Data loaded from Firestore:", checklistData);
                    } else {
                        checklistData = {};
                        console.log("No data found, starting fresh.");
                    }
                    // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã«UIã‚’æ›´æ–°
                    updateThemeSelect();
                    renderChecklist();
                    updateDashboard();
                }, (error) => {
                    console.error("Firestore onSnapshot error:", error);
                    document.getElementById('status-message').innerHTML = `<p class="font-bold">ã‚¨ãƒ©ãƒ¼:</p><p>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚${error.code}</p>`;
                });

            } else {
                // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¾ãŸã¯èªè¨¼åˆ‡ã‚Œã®å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯åŒ¿åèªè¨¼ã‚’è©¦è¡Œ
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        document.getElementById('status-message').innerHTML = `<p class="font-bold">èªè¨¼è©¦è¡Œä¸­...</p><p>ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>`;
                    } else {
                        await signInAnonymously(auth);
                        document.getElementById('status-message').innerHTML = `<p class="font-bold">èªè¨¼è©¦è¡Œä¸­...</p><p>åŒ¿åèªè¨¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>`;
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    document.getElementById('status-message').innerHTML = `<p class="font-bold">ã‚¨ãƒ©ãƒ¼:</p><p>èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚${error.code}</p>`;
                }
            }
        });

        // --- Firestore ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–¢æ•° ---
        async function saveChecklistData() {
            if (!isAuthReady || !userId) {
                console.error("Auth not ready. Cannot save data.");
                return;
            }
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'biology_checklist', 'checklist_data');
            try {
                // setDocã§ä¸Šæ›¸ãä¿å­˜
                await setDoc(docRef, checklistData, { merge: true });
                console.log("Checklist data saved successfully.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // --- UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

        // ãƒ†ãƒ¼ãƒé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
        function updateThemeSelect() {
            const select = document.getElementById('theme-select');
            select.innerHTML = ''; // ã‚¯ãƒªã‚¢

            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            Object.keys(BIOLOGY_TOPICS).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = BIOLOGY_TOPICS[id].name;
                select.appendChild(option);
            });
            
            // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ¼ãƒã‚’è¨­å®š
            select.value = currentThemeId;

            // é¸æŠå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            select.addEventListener('change', (e) => {
                currentThemeId = e.target.value;
                renderChecklist();
            });
        }

        // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderChecklist() {
            const theme = BIOLOGY_TOPICS[currentThemeId];
            const checklistContainer = document.getElementById('checklist');
            document.getElementById('current-theme-title').textContent = theme ? theme.name : 'ãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦ãã ã•ã„';
            checklistContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢

            if (!theme) return;

            // ãƒ†ãƒ¼ãƒã®é€²æ—ã‚’è¨ˆç®—ã—è¡¨ç¤º
            const currentThemeItems = Object.keys(theme.items).length;
            const checkedItemsInTheme = Object.keys(theme.items).filter(itemId => checklistData[itemId]).length;
            const themeProgress = currentThemeItems > 0 ? Math.round((checkedItemsInTheme / currentThemeItems) * 100) : 0;
            document.getElementById('theme-progress-text').textContent = `${themeProgress}%`;

            // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã‚’ç”Ÿæˆ
            Object.keys(theme.items).forEach(itemId => {
                const item = theme.items[itemId];
                const isChecked = !!checklistData[itemId];
                const itemHtml = `
                    <div class="checklist-item flex items-start p-3 rounded-lg border border-gray-200 shadow-sm transition duration-150 ease-in-out">
                        <input type="checkbox" id="${itemId}" data-item-id="${itemId}" class="mt-1 h-5 w-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500" ${isChecked ? 'checked' : ''}>
                        <label for="${itemId}" class="ml-3 text-base text-gray-700 cursor-pointer">
                            <span class="font-semibold ${item.level === 1 ? 'text-blue-600' : 'text-purple-600'}">${item.level === 1 ? 'L1 ã‚³ã‚¢çŸ¥è­˜' : 'L2 æµã‚Œãƒ»ãƒ—ãƒ­ã‚»ã‚¹'}ï¼š</span> ${item.text.replace(/L\d\s(ã‚³ã‚¢çŸ¥è­˜|æµã‚Œãƒ»ãƒ—ãƒ­ã‚»ã‚¹):?\s*/, '')}
                        </label>
                    </div>
                `;
                checklistContainer.insertAdjacentHTML('beforeend', itemHtml);
            });

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const itemId = e.target.dataset.itemId;
                    checklistData[itemId] = e.target.checked;
                    saveChecklistData();
                    updateDashboard();
                    
                    // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒé€²æ—ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°
                    const updatedCheckedItems = Object.keys(theme.items).filter(id => checklistData[id]).length;
                    const updatedProgress = currentThemeItems > 0 ? Math.round((updatedCheckedItems / currentThemeItems) * 100) : 0;
                    document.getElementById('theme-progress-text').textContent = `${updatedProgress}%`;
                });
            });
        }

        // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ›´æ–° ---
        function updateDashboard() {
            // å…¨ä½“é …ç›®ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’è¨ˆç®—
            const totalItemsInTopics = Object.values(BIOLOGY_TOPICS).flatMap(t => Object.keys(t.items));
            const checkedCount = totalItemsInTopics.filter(itemId => checklistData[itemId]).length;

            const totalCount = ALL_ITEMS;
            const progress = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;

            // 1. å…¨ä½“é€²æ—ãƒãƒ¼ã®æ›´æ–°
            document.getElementById('overall-progress').innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <p class="text-lg font-medium text-gray-800">å…¨ä½“ç¿’å¾—ç‡</p>
                    <span class="text-2xl font-extrabold text-emerald-600">${progress}%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                </div>
            `;
            
            // 2. L1/L2ç¿’å¾—ãƒãƒ©ãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆã®æ›´æ–°
            const levelCounts = calculateLevelProgress();
            updateLevelChart(levelCounts);

            // 3. ãƒ†ãƒ¼ãƒåˆ¥ç¿’å¾—ç‡ãƒãƒ£ãƒ¼ãƒˆã®æ›´æ–°
            const themeProgress = calculateThemeProgress();
            updateThemeChart(themeProgress);
        }

        // ã‚¢ã‚¤ãƒ†ãƒ IDã‹ã‚‰ãƒ†ãƒ¼ãƒIDã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getThemeId(itemId) {
            for (const themeId in BIOLOGY_TOPICS) {
                if (BIOLOGY_TOPICS[themeId].items[itemId]) {
                    return themeId;
                }
            }
            return null;
        }

        // L1/L2ã®é€²æ—ã‚’è¨ˆç®—
        function calculateLevelProgress() {
            let totalL1 = 0;
            let checkedL1 = 0;
            let totalL2 = 0;
            let checkedL2 = 0;

            Object.values(BIOLOGY_TOPICS).forEach(theme => {
                Object.keys(theme.items).forEach(itemId => {
                    const item = theme.items[itemId];
                    const isChecked = checklistData[itemId];
                    
                    if (item.level === 1) {
                        totalL1++;
                        if (isChecked) checkedL1++;
                    } else if (item.level === 2) {
                        totalL2++;
                        if (isChecked) checkedL2++;
                    }
                });
            });

            return {
                L1: { checked: checkedL1, total: totalL1, progress: totalL1 > 0 ? Math.round((checkedL1 / totalL1) * 100) : 0 },
                L2: { checked: checkedL2, total: totalL2, progress: totalL2 > 0 ? Math.round((checkedL2 / totalL2) * 100) : 0 }
            };
        }

        // ãƒ†ãƒ¼ãƒåˆ¥é€²æ—ã‚’è¨ˆç®—
        function calculateThemeProgress() {
            const progressData = {};
            Object.keys(BIOLOGY_TOPICS).forEach(themeId => {
                const theme = BIOLOGY_TOPICS[themeId];
                const total = Object.keys(theme.items).length;
                const checked = Object.keys(theme.items).filter(itemId => checklistData[itemId]).length;
                progressData[theme.name] = total > 0 ? Math.round((checked / total) * 100) : 0;
            });
            return progressData;
        }

        // L1/L2ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateLevelChart(counts) {
            
            const config = {
                type: 'doughnut',
                data: {
                    labels: ['ç¿’å¾—æ¸ˆ', 'æœªç¿’å¾—'],
                    datasets: [
                        {
                            label: 'L1 ã‚³ã‚¢çŸ¥è­˜',
                            data: [counts.L1.checked, counts.L1.total - counts.L1.checked],
                            backgroundColor: ['#3b82f6', '#dbeafe'],
                            hoverBackgroundColor: ['#2563eb', '#bfdbfe'],
                            borderWidth: 0,
                            // Doughnutãƒãƒ£ãƒ¼ãƒˆã§ã¯ä¸è¦ãªãŸã‚ 'stack' ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‰Šé™¤
                        },
                        {
                            label: 'L2 æµã‚Œãƒ»ãƒ—ãƒ­ã‚»ã‚¹',
                            data: [counts.L2.checked, counts.L2.total - counts.L2.checked],
                            backgroundColor: ['#a855f7', '#f3e8ff'],
                            hoverBackgroundColor: ['#9333ea', '#e9d5ff'],
                            borderWidth: 0,
                            // Doughnutãƒãƒ£ãƒ¼ãƒˆã§ã¯ä¸è¦ãªãŸã‚ 'stack' ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‰Šé™¤
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'L1/L2 ç¿’å¾—ãƒãƒ©ãƒ³ã‚¹',
                            font: { size: 14 }
                        }
                    }
                }
            };

            if (levelChart) levelChart.destroy();
            levelChart = new Chart(levelChartCtx, config);
        }

        // ãƒ†ãƒ¼ãƒåˆ¥ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateThemeChart(progress) {
            const themeNames = Object.keys(progress);
            const progressValues = Object.values(progress);

            const data = {
                labels: themeNames,
                datasets: [{
                    label: 'ç¿’å¾—ç‡ (%)',
                    data: progressValues,
                    backgroundColor: progressValues.map(v => v === 100 ? '#059669' : '#34d399'), // 100%ã¯æ¿ƒã„ç·‘
                    borderColor: progressValues.map(v => v === 100 ? '#047857' : '#059669'),
                    borderWidth: 1,
                    hoverBackgroundColor: progressValues.map(v => v === 100 ? '#047857' : '#10b981'),
                }]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    indexAxis: 'y', // æ¨ªæ£’ã‚°ãƒ©ãƒ•
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'ç¿’å¾—ç‡ (%)'
                            }
                        },
                        y: {
                            // stacked: true, // ã“ã‚Œã¯æ£’ã‚°ãƒ©ãƒ•ã§é©åˆ‡ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒç©ã¿ä¸Šã’ï¼ˆstackï¼‰ã§ã¯ãªã„ãŸã‚ã€ä¸è¦
                            title: {
                                display: true,
                                text: 'å­¦ç¿’ãƒ†ãƒ¼ãƒ'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: 'ãƒ†ãƒ¼ãƒåˆ¥ç¿’å¾—ç‡',
                            font: { size: 14 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x}%`;
                                }
                            }
                        }
                    }
                }
            };

            if (themeChart) themeChart.destroy();
            themeChart = new Chart(themeChartCtx, config);
        }
        
    </script>
</body>
</html>
